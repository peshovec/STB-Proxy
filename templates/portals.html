{% extends "base.html" %}
{% block content %}

<div class="container-fluid p-lg-5">

    <div>
        <button class="btn btn-success btn-block" title="Add Portal" id="openModal" data-bs-toggle="modal"
            data-action="add"><i class="fa fa-plus"></i> Add Portal</button>
    </div>

    <br>

    <div class="row row-cols-auto" id="streamOut">
        <!-- Add Card for every portal in config data  -->
        {% if portals is not none %}
        {% for portal in portals %}
        <div class="col">
            <div class="card text-dark bg-light mb-3">
                <div class="card-header btn text-start stretched-link" data-id="{{ portal }}"
                    data-enabled="{{ portals[portal].enabled }}" data-name="{{ portals[portal].name }}"
                    data-url="{{ portals[portal].url }}" data-proxy="{{ portals[portal].proxy }}"
                    data-macs="{{ portals[portal].macs|tojson|forceescape }}" 
                    data-streamsPerMac="{{ portals[portal]['streams per mac'] }}" data-bs-toggle="modal"
                    data-time_zone="{{ portals[portal]['time_zone'] }}"
                    data-epgTimeOffset="{{ portals[portal].epgTimeOffset }}" data-action="edit"
                    data-bs-target="#modalForm">
                    <i class="me-2 fa fa-server" {{ "hidden" if portals[portal].enabled == 'false' }}></i>
                    <i class="me-2 fa fa-ban" {{ "hidden" if portals[portal].enabled == 'true' }}></i>
                    {{ portals[portal].name }}
                </div>
                <div class="card-body" style="font-size: 80%">
                    <table id="macTable" class="table table-sm mt-2">
                        <thead>
                            <tr>
                                <th>MAC Address</th>
                                <th>Expiry</th>
                                <th>Playtime</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in portals[portal].macs.items() %}
                            <tr>
                                <td>{{ key }}</td>
                                <td id="data-expDate-{{ portals[portal].name }}-{{ loop.index }}"></td>
                                <td id="data-playtime-{{ portals[portal].name }}-{{ loop.index }}"></td>
                                <td id="data-error-rate-{{ portals[portal].name }}-{{ loop.index }}"></td>
                            </tr>

                            <script>
                                var dateVal = document.getElementById("data-expDate-{{ portals[portal].name }}-{{ loop.index }}");
                                var playtimeVal = document.getElementById("data-playtime-{{ portals[portal].name }}-{{ loop.index }}");
                                var errorRateVal = document.getElementById("data-error-rate-{{ portals[portal].name }}-{{ loop.index }}");

                                var expiryTimestamp = {{ value.expiry | tojson }};
                                if (expiryTimestamp !== null) {
                                    var now = Date.now();
                                    var expires = expiryTimestamp * 1000;
                                    var diff = expires - now;
                                    var daysAway = diff / (1000 * 3600 * 24);

                                    var dateFormat = { year: 'numeric', month: '2-digit', day: '2-digit' };
                                    var formattedDate = new Date(expires).toLocaleDateString(undefined, dateFormat);
                                    dateVal.innerHTML = formattedDate;

                                    if (now > expires) {
                                        dateVal.parentElement.classList.add("table-danger");
                                    } else if (daysAway < 30) {
                                        dateVal.parentElement.classList.add("table-warning");
                                    }
                                } else {
                                    dateVal.innerHTML = "N/A";
                                }

                                var playtime = {{ value.stats.playtime | tojson }};
                                if (playtime !== null) {
                                    var hours = Math.floor(playtime / 3600);
                                    var minutes = Math.floor((playtime % 3600) / 60);
                                    var seconds = Math.floor(playtime % 60);
                                    var formattedPlaytime = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                                    playtimeVal.innerHTML = formattedPlaytime;
                                } else {
                                    playtimeVal.innerHTML = "N/A";
                                }

                                var errors = {{ value.stats.errors | tojson }};
                                var requests = {{ value.stats.requests | tojson }};
                                if (errors !== null && requests !== null && requests !== 0) {
                                    var errorRate = (errors / requests * 100).toFixed(0);
                                    errorRateVal.innerHTML = errorRate + "%";
                                } else {
                                    errorRateVal.innerHTML = "N/A";
                                }
                            </script>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Unified Add/Edit Modal -->
<div class="modal fade text-dark" id="modalForm" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add/Edit Portal</h5>
                <div class="form-check form-switch ms-auto">
                    <input type="checkbox" form="portalForm" class="form-check-input" name="enabled"
                        id="modalEnabled" value="true">
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="portalForm" action="/portal/add" method="post">
                    <input name="id" id="modalId" hidden>

                    <h6>Name:</h6>
                    <input type="text" name="name" id="modalName" class="form-control flex-fill" title="Name" required>
                    <span class="text-muted">Give this portal a name.</span>

                    <br><br>

                    <h6>URL:</h6>
                    <input type="text" name="url" id="modalUrl" class="form-control flex-fill" title="URL" required>
                    <span class="text-muted">It's best to enter the full address ending in .php if you know it.<br>If not, STB-Proxy will attempt to figure it out for you.</span>

                    <br><br>

                    <h6>Proxy:</h6>
                    <input type="text" name="proxy" id="modalProxy" class="form-control flex-fill" title="Proxy">
                    <span class="text-muted">STB-Proxy supports HTML proxies only.</span>

                    <br><br>

                    <h6>MAC Addresses:</h6>
                    <table class="table table-sm" id="macTable">
                        <thead>
                            <tr>
                                <th>MAC Address</th>
                                <th>Expiry</th>
                                <th>Playtime</th>
                                <th>Error Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="macList">
                            <!-- MAC addresses will be loaded here -->
                        </tbody>
                    </table>
                    <textarea id="macInput" class="form-control" rows="3"
                        placeholder="Enter MAC addresses or text here"></textarea>
                    <button type="button" class="btn btn-primary mt-2" id="parseMacBtn">Parse MAC Addresses</button>
                    <button type="button" class="btn btn-warning mt-2 ms-2" id="modalRetestBtn">Retest</button>

                    <!-- Hidden input to store MAC addresses -->
                    <input type="hidden" name="macs" id="macsHiddenInput">

                    <br><br>

                    <h6>Streams Per MAC:</h6>
                    <input type="number" name="streams per mac" id="modalStreamsPerMac" class="form-control flex-fill"
                        title="Streams Per Mac" min="0" value="1" required>
                    <span class="text-muted">How many streams does each MAC allow. 0 = unlimited.</span>

                    <br><br>

                    <h6>EPG Time Offset:</h6>
                    <input type="number" name="epg time offset" id="modalEpgTimeOffset" class="form-control flex-fill"
                        title="EPG Time Offset" min="-12" max="14" step="0.5" value="0" required>
                    <span class="text-muted">Time offset for XMLTV EPG data (Reference UTC). Range: -12 to +14, in 0.5-hour increments.</span>

                    <br><br>

                    <h6>Timezone:</h6>
                    <input type="text" name="time_zone" class="form-control flex-fill" title="Timezone" value="Europe/London">
                    <span class="text-muted">Optional Timezone.</span>

                    <br><br>

                    <div class="modal-footer">
                        <button class="btn btn-danger" id="modalDelete" type="submit" form="delete">Delete</button>
                        <button class="btn btn-warning" id="modalRetestBtn" type="button">Retest</button>
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary" id="modalSubmit" type="submit" onclick="prepareMacsData()">Save</button>
                    </div>
                </form> 

                 <form id="delete" action="/portal/remove" method="post" onsubmit="return confirm('Confirm Delete');" hidden>
                    <input type="text" name="deleteId" id="deleteId" value="">
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to handle the opening of the modal for add/edit actions
    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
        button.addEventListener('click', handleModal);
    });

    function handleModal(event) {
        var button = event.currentTarget;
        var action = button.getAttribute('data-action');
        var modal = document.getElementById('modalForm');
        var form = document.getElementById('portalForm');
        var submitButton = document.getElementById('modalSubmit');
        var deleteButton = document.getElementById('modalDelete');
        var retestButton = document.getElementById('modalRetestBtn');
        var title = document.getElementById('modalTitle');
        var id = button.getAttribute('data-id');
        document.getElementById('deleteId').value = id;

        if (action === 'add') {
            form.action = "/portal/add";
            form.reset();
            title.textContent = "Add Portal";
            submitButton.textContent = "Add";
            deleteButton.style.display = 'none';
            retestButton.style.display = 'none';

            var macList = document.getElementById('macList');
            macList.innerHTML = '';

        } else if (action === 'edit') {
            form.action = "/portal/update";
            title.textContent = "Edit Portal";
            submitButton.textContent = "Update";
            deleteButton.style.display = 'block';
            retestButton.style.display = 'block';

            // Fill in form with existing data
            var id = button.getAttribute('data-id');
            var name = button.getAttribute('data-name');
            var enabled = button.getAttribute('data-enabled');
            var url = button.getAttribute('data-url');
            var proxy = button.getAttribute('data-proxy');
            var macs = JSON.parse(button.getAttribute('data-macs'));
            var streamsPerMac = button.getAttribute('data-streamsPerMac');
            var epgTimeOffset = button.getAttribute('data-epgTimeOffset');

            document.getElementById('modalId').value = id;
            document.getElementById('modalName').value = name;
            document.getElementById('modalEnabled').checked = (enabled === 'true');
            document.getElementById('modalUrl').value = url;
            document.getElementById('modalProxy').value = proxy;
            document.getElementById('modalStreamsPerMac').value = streamsPerMac;
            document.getElementById('modalEpgTimeOffset').value = epgTimeOffset;

            var macList = document.getElementById('macList');
            macList.innerHTML = '';

            Object.keys(macs).forEach((mac, index) => {
                var data = macs[mac];
                addMacRow(mac, data, index);
            });
        }

        var myModal = new bootstrap.Modal(modal, { backdrop: 'static' });
        myModal.show();
    }

    // Function to prepare the MAC addresses data before form submission
    function prepareMacsData() {
        const macList = document.getElementById('macList');
        const macs = Array.from(macList.querySelectorAll('tr')).map(row => row.cells[0].textContent);
        document.getElementById('macsHiddenInput').value = JSON.stringify(macs);
    }

    // Function to parse MAC addresses and test them with a server call
    document.getElementById('parseMacBtn').addEventListener('click', function () {
        var macInput = document.getElementById('macInput').value;
        var macPattern = /[0-9A-Fa-f]{2}([-:]?)([0-9A-Fa-f]{2}\1){4}[0-9A-Fa-f]{2}/g;
        var macMatches = macInput.match(macPattern);

        if (macMatches) {
            // Make AJAX request to test the new MAC addresses
            fetch('/portal/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    macs: macMatches,
                    id: document.getElementById('modalId').value,
                    name: document.getElementById('modalName').value,
                    url: document.getElementById('modalUrl').value,
                    proxy: document.getElementById('modalProxy').value,
                    streamsPerMac: document.getElementById('modalStreamsPerMac').value,
                    epgTimeOffset: document.getElementById('modalEpgTimeOffset').value,
                    enabled: document.getElementById('modalEnabled').checked ? 'true' : 'false',
                })
            })
            .then(response => response.json())
            .then(data => {
                // Update the MAC table with the response data
                var macList = document.getElementById('macList');
                macList.innerHTML = '';
                data.validMacs.forEach((elem, index) => {
                    addMacRow(elem.mac, { expiry: elem.expiry, stats: elem.stats }, index);
                });
                document.getElementById('macInput').value = '';
            })
            .catch(error => {
                console.error('Error testing MAC addresses:', error);
            });
        } else {
            alert('No valid MAC addresses found.');
        }
    });

    // Function to add a row in the MAC table
    function addMacRow(mac, data, index) {
        var macList = document.getElementById('macList');
        var row = document.createElement('tr');

        var macCell = document.createElement('td');
        macCell.textContent = mac;

        var expiryCell = document.createElement('td');
        expiryCell.textContent = formatExpiry(data.expiry);

        var playtimeCell = document.createElement('td');
        playtimeCell.textContent = formatPlaytime(data.stats.playtime);

        var errorCell = document.createElement('td');
        errorCell.textContent = formatErrorRate(data.stats.errors, data.stats.requests);

        var actionCell = document.createElement('td');
        var upButton = document.createElement('button');
        upButton.className = 'btn btn-sm btn-light p-0 me-1';
        upButton.innerHTML = '<i class="bx bx-chevron-up"></i>';
        upButton.type = 'button';
        upButton.disabled = !row.previousElementSibling;
        upButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (row.previousElementSibling) {
                macList.insertBefore(row, row.previousElementSibling);
                updateButtonStates(macList);
            }
        });

        var downButton = document.createElement('button');
        downButton.className = 'btn btn-sm btn-light p-0 me-1';
        downButton.innerHTML = '<i class="bx bx-chevron-down"></i>';
        downButton.type = 'button';
        downButton.disabled = !row.nextElementSibling;
        downButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (row.nextElementSibling) {
                macList.insertBefore(row.nextElementSibling, row);
                updateButtonStates(macList);
            }
        });

        var deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-sm btn-light p-0 me-1';
        deleteButton.innerHTML = '<i class="bx bx-x bx-tada-hover" style="color:red;"></i>';
        deleteButton.type = 'button';
        deleteButton.addEventListener('click', (e) => {
            e.preventDefault();
            row.remove();
            updateButtonStates(macList);
        });

        actionCell.appendChild(upButton);
        actionCell.appendChild(downButton);
        actionCell.appendChild(deleteButton);

        row.appendChild(macCell);
        row.appendChild(expiryCell);
        row.appendChild(playtimeCell);
        row.appendChild(errorCell);
        row.appendChild(actionCell);

        macList.appendChild(row);
        updateButtonStates(macList);
    }

    function updateButtonStates(macList) {
        Array.from(macList.rows).forEach((row, index) => {
            var upButton = row.querySelector('.bx-chevron-up').parentElement;
            var downButton = row.querySelector('.bx-chevron-down').parentElement;
            upButton.disabled = index === 0;
            downButton.disabled = index === macList.rows.length - 1;
        });
    }

    // Helper function to format exp
    function formatExpiry(expiryTimestamp) {
        if (expiryTimestamp !== null) {
            var now = Date.now();
            var expires = expiryTimestamp * 1000;
            var dateFormat = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(expires).toLocaleDateString(undefined, dateFormat);
        }
        return "N/A";
    }

    // Helper function to format playtime
    function formatPlaytime(playtime) {
        if (playtime !== null) {
            var hours = Math.floor(playtime / 3600);
            var minutes = Math.floor((playtime % 3600) / 60);
            var seconds = Math.floor(playtime % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        return "N/A";
    }

    // Helper function to format error rate
    function formatErrorRate(errors, requests) {
        if (errors !== null && requests !== null && requests !== 0) {
            return `${(errors / requests * 100).toFixed(0)}%`;
        }
        return "N/A";
    }
    
    // Ensure the main content is not inactive when modal closes
    document.querySelectorAll('.btn-close, [data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function () {
            var myModalEl = document.getElementById('modalForm');
            var modal = bootstrap.Modal.getInstance(myModalEl);
            if (modal) {
                modal.hide();
            }
        });
    });
</script>

{% endblock %}
